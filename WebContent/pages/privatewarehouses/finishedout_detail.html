<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>成品出库-新增/修改</title>

    <!-- Bootstrap Core CSS -->
    <link href="../../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../../../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
	<link href="../../../css/admin.css" rel="stylesheet">
	<link href="../../../resource/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
	<style type="text/css">
		body { margin:0 15px;}
		form { margin-top:20px;}
		label { padding-top:6px;padding-right:0;}
		
		th{text-align: center;}
		td{text-align: center;}
		body{  
		    overflow-x: hidden;   
		}
		.inputclass{text-align:center;padding:0;width: 72px;height: 26px} 
		.selectclass{padding:0 0 0 2px;width: 168px;height: 26px}
 
		.form-group.form-group-sm
        {
            margin-right: 5px !important;
            margin-left: 5px !important;
        }
        tbody .form-group {
            margin-bottom: 0px;
        }
	</style>
	
    <!-- Custom Fonts -->
    <link href="../../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<style>

</style>
<body>
<form class="form-horizontal" role="form" style="margin-top: 20px" id="defaultForm">
	<#if outgoing??>
	<input hidden="" name="finished_product_outgoing_id" id="finished_product_outgoing_id" value="${outgoing.id!}">       
	<div class="col-xs-6">
        <div>
            <div class="form-group">
                <label class="col-xs-4 control-label text-right" for="storage_number">出库单号：</label>
                <div class="col-xs-8">
                    <input class="form-control text-left" id="storage_number" type="text" placeholder="系统自动生成" name="storage_number" value="${outgoing.outgoing_number!}" readonly/>
                </div>
            </div>
        </div>
        <div>
            <div class="form-group">
                <label class="col-xs-4 control-label text-right" for="company_id">客户名 ：</label>
                <div class="col-xs-8">
                    <select class="form-control" name="company_id" id="company_id">
                       <option value="">请选择客户</option>
                       <#if companyList?? && companyList?size gt 0>
                       <#list companyList as company>
                       <option value="${company.id}" <#if outgoing.company = company.id>selected</#if> >${company.company_name}</option>
                       </#list>
                       </#if>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xs-6">
        
        <div>
             <div class="form-group">
                <label class="col-xs-4 control-label text-right" for="t_user_id">出库人：</label>
                <div class="col-xs-8">
                    <input class="form-control text-left" id="t_user_id" type="text" placeholder="系统自动录入" name="t_user_id" value="${outgoing.user_name!}" readonly/>
                </div>
            </div>
        </div>
        <div>
             <div class="form-group">
                <label class="col-xs-4 control-label text-right" for="remark">备注：</label>
                <div class="col-xs-8">
                    <input class="form-control text-left" id="remark" type="text" placeholder="备注" name="remark"  value="${outgoing.remark!}"/>
                </div>
            </div>
        </div>
    </div>
	<#else>
	<input id="id" name="finished_product_outgoing_id" value="" hidden="">
	<div class="col-xs-6">
		<div>
		    <div class="form-group">
		        <label class="col-xs-4 control-label text-right" for="storage_number">出库单号：</label>
		        <div class="col-xs-8">
		            <input class="form-control text-left" id="storage_number" type="text" placeholder="系统自动生成" name="storage_number" value="" readonly/>
		        </div>
		    </div>
		</div>
		<div>
            <div class="form-group">
                <label class="col-xs-4 control-label text-right" for="company_id">客户名 ：</label>
                <div class="col-xs-8">
                    <select class="form-control" name="company_id" id="company_id">
                       <option value="">请选择客户</option>
                       <#if companyList?? && companyList?size gt 0>
                       <#list companyList as company>
                       <option value="${company.id}">${company.company_name}</option>
                       </#list>
                       </#if>
                    </select>
                </div>
            </div>
        </div>
	</div>
	<div class="col-xs-6">
	    
	    <div>
             <div class="form-group">
                <label class="col-xs-4 control-label text-right" for="t_user_id">出库人：</label>
                <div class="col-xs-8">
                    <input class="form-control text-left" id="t_user_id" type="text" placeholder="系统自动录入" name="t_user_id" value="" readonly/>
                </div>
            </div>
        </div>
	    <div>
	         <div class="form-group">
	            <label class="col-xs-4 control-label text-right" for="remark">备注：</label>
	            <div class="col-xs-8">
	                <input class="form-control text-left" id="remark" type="text" placeholder="备注" name="remark"/>
	            </div>
	        </div>
	    </div>
    </div>
	</#if>
	<div style="width:100%;height:110px;"></div>
<div id="wrapper">
	<div class="panel-body" style="padding-bottom:0px;">
		<div class="panel panel-default">		
			<div class="panel-heading">					
				<div class="container container-fluid" >				
					<div class="row">
						<div class="col-sm-2 col-xs-6 head_1" style="width:60px;padding-left: 0;margin-left: 0">
		                    <button class="btn btn-success" type="button" onclick="_add()">新增</button>
		                </div>	          
                        <div class="col-sm-2 col-xs-6 head_1" style="padding-left: 0;margin-left: 0">
		                     <button class="btn btn-4" type="button" onclick="_batchDelete()">删除</button>
		                </div>
		                <!-- <div class="col-sm-2 col-xs-3 head_2" style="margin-top: 6px;margin-left: 300px;text-align: right;">
                            <span style="font-size: 18px">产品编号:</span>
                        </div> 
		                <div class="col-sm-3 col-xs-4 head_2" style="margin-left: 0px">
                            <input type="text" class="form-control" placeholder="扫码点击此处" name="ProductCodeInfo" id="ProductCodeInfo" value="" >
                        </div>  -->         									                            									                 
					</div>				
				</div>
			</div>		
			<table width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example">
           <thead>
              <tr>
              	<th><input type="checkbox" id="checkAll"></th>
                <th>序号</th>
                <th>产品编号</th>
                <th>品名</th>
                <th>规格</th>
                <th>单位</th>
                <th>备注</th>
                <th>对应仓库</th>
                <!-- <th>剩余数量</th> -->
                <th>出库数量</th>
              </tr>
              </thead>
              <tbody>
              	<#if outgoingDetailList?? && outgoingDetailList?size gt 0>
                <#list outgoingDetailList as outgoingDetail>
                <tr class="data">
                    <td>
                        <input type="checkbox" name="sub" value="" >
                        <input hidden="" name="id" value="${outgoingDetail.stock_detail_id!}">
                        <input hidden="" name="warehouse_id" value="${outgoingDetail.warehouse_id!}">
                        <input hidden="" name="finished_product_id" value="${outgoingDetail.finished_product_id!}">
                    </td>
                    <td>${outgoingDetail_index+1}</td>
                    <td>${outgoingDetail.finished_number!}</td>
                    <td>${outgoingDetail.trade_name!}</td>
                    <td>${outgoingDetail.specifications!}</td>
                    <td>${outgoingDetail.measurement_unit!}</td>
                    <td>${outgoingDetail.remark!}</td>
                    <td>${outgoingDetail.warehouse_name!}</td>
                    <!-- <td>${outgoingDetail.num!}</td> -->
                    <td class="num"><div class="form-group form-group-sm"><input class="form-control" type="text" name="num" value="${outgoingDetail.num!}"/></div></td>
                </tr>
                </#list>
                <#else>
                <!-- <td colspan="5">暂无</td> -->
                </#if>          
              </tbody>
          </table>
		</div>             
	</div>
</div>
    <div class="form-group" style="padding-left: 16px">
        <div class="col-xs-8">
            <button id="submit" type="button" class="btn btn-primary">　保存　</button>
        </div>
    </div>
</form>
<!-- jQuery -->
<script src="../../../vendor/jquery/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="../../../vendor/bootstrap/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="../../../vendor/metisMenu/metisMenu.min.js"></script>
<script src="../../../resource/layer/layer.js"></script>
<script src="../../../resource/layui/layui.js"></script>
<!-- Custom Theme JavaScript -->
<script src="../../../resource/bootstrapvalidator/js/bootstrapValidator.min.js"></script>
<script src="../../../js/common/admin.js"></script>
<script type="text/javascript">
document.onkeydown = function(e) {
    var e = e || event;
    if(e.keyCode == 13) {
    	 $("#ProductCodeInfo").keydown(function (e) {
			 AddProduct(this);
    	})
        e.preventDefault ? e.preventDefault() : (e.returnValue = false);
    }
}

// 提交
$('#submit').click(function () {
	// 绑定校验
	var validator = bindValidator('form');
	validator.data('bootstrapValidator').validate();
	if (!validator.data('bootstrapValidator').isValid()) {
		return; // 校验不通过，禁止提交
	}
	
	var outgoingDetailList = getRecordList(); // 出库详情列表
	// 无数据，禁止提交
	if (outgoingDetailList.length == 0) {
		layer.msg("请添加产品数据", {time: 2000});
		return;
	}
    var id = $("#finished_product_outgoing_id").val(); // 出库单 id
    var company_id = $('#company_id').val(); // 客户 id
    var remark = $('#remark').val() // 备注
    $.post("/private/finishedout/save", {"outgoingDetailList": JSON.stringify(outgoingDetailList),"id": id,"company_id":company_id,"remark":remark}, function(result) {
    	if (result.isSuccess) {
            parent.layer.msg(result.tips, {time: 2000}, function(){
                layer_close();
                parent.parent.refresh_iframe();
            });

        } else {
            parent.layer.msg(result.tips, {time: 2000});
        }
    });
});
// 出库详情列表
function getRecordList() {
	var recordList = [];
	 
	$('tbody tr[class="data"]').each(function () {
	    $tr = $(this);
	    var id = $tr.find('input[name="id"]').val(); // 成品库存detail id
	    var finished_product_id = $tr.find('input[name="finished_product_id"]').val(); // 成品 id
	    var warehouse_id = $tr.find('input[name="warehouse_id"]').val(); // 仓库 id
	    var num = $tr.find('input[name="num"]').val(); // 出库数量
	    var record = {};
	    record.id = id;
	    record.finished_product_id = finished_product_id;
	    record.warehouse_id = warehouse_id;
	    record.num = num;
	    recordList.push(record);
	});
	
	return recordList;
}
//绑定校验
function bindValidator(obj){
    // 表单校验
    var validator = $(obj).bootstrapValidator({
        //message: 'This value is not valid',
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            num: {
                validators: {
                    notEmpty:{
                        message: '不能为空!'
                    },
                    regexp: {
                        regexp: /^[0-9]+(\.[0-9]{1,})?$/,
                        message: '请输入正确的数量'
                    },
                    stringLength: {
                        min: 0,
                        max: 20,
                        message: '不能超过 20 个字符',
                    }
                }
            },
            company_id: {
                validators: {
                    notEmpty:{
                        message: '不能为空!'
                    },
                    stringLength: {
                        min: 0,
                        max: 20,
                        message: '不能超过 20 个字符',
                    }
                }
            },
            remark: {
                validators: {
                    stringLength: {
                        min: 0,
                        max: 100,
                        message: '不能超过 100 个字符',
                    }
                }
            }

        }
    });
    return validator;
}

// 新增出库产品
var stockList = ${stockList!}; // 库存所有产品列表
$(stockList).each(function () {
	this.selected = false;
});
// 选择产品列表页面
function _add(){
	open_window('新增成品出库','/private/finishedout/getStockList', 820, 540);
}

// 产品数据展示到页面
function contains (array, element ) {
    for (i in array) {
        if (array[i] == element) return true;
    }
    return false;
}
function addProducts(productNoList) {
	// 页面已有产品
	var existProductNoList = getExistProductList();
	// 排除已存在的与未选中的产品
	$(stockList).each(function (index, obj) {
		if (!contains(productNoList, obj.id)) {
			return true; 
		}
		if (contains(existProductNoList, obj.id)) {
            return true; // 排除已存在的
        }
		addProduct(obj); // 数据展示到页面
	});
    sort(); // 排序
}
// 页面已有的产品
function getExistProductList() {
	var existProductNoList = new Array();
    $('tr').each(function () {
        existProductNoList.push($(this).find('input[name="id"]').val());
    });
    return existProductNoList;
}
// 单条产品数据展示到页面
function addProduct(obj) {
	var product = '<tr class="data">'+
                    '<td>'+
                        '<input type="checkbox" name="sub" value="" >'+
                        '<input hidden="" name="id" value="' + obj.id + '">'+
                        '<input hidden="" name="warehouse_id" value="' + obj.warehouse_id + '">'+
                        '<input hidden="" name="finished_product_id" value="' + obj.finished_product_id + '">'+
                    '</td>'+
                    '<td></td>'+
                    '<td name="finished_number">' + obj.finished_number + '</td>'+
                    '<td>' + obj.trade_name + '</td>'+
                    '<td>' + obj.specifications + '</td>'+
                    '<td>' + obj.measurement_unit + '</td>'+
                    '<td>' + obj.remark + '</td>' +
                    '<td>' + obj.warehouse_name + '</td>' +
                    //'<td>' + obj.num + '</td>' +
                    '<td>'+
                        '<div class="form-group form-group-sm">'+
                            '<input type="text" class="form-control" name="num" value="' + obj.left_quantity + '">'+
                        '</div>'+
                    '</td>'+
                '</tr>';
    $('tbody').append(product);
}

// 编辑产品出库数量详细
function _edit(finished_number) {
	open_window('成品出库详情','/private/finishedout/getStockDetailByProductNo/' + finished_number, 720, 540);
}


//删除页面数据
function _batchDelete(){
    $("input[name='sub']:checked").each(function(k,v){
	    $(v).parent().parent().remove();
	    sort();
	});
}

//页面序号排序
function sort(){
	$("tbody").find(".flag").remove();
	$("tbody tr").each(function(k,v){
		var index = k+1;
		$(v).find("td").eq(1).html(index);
	})
	if($("tbody").find("tr").length==0){
		$("tbody").append("<tr class='flag'><td colspan='9' style='text-align: center;'>暂无产品数据,请点击新增添加</td></tr>");
	}
}
sort();


//删除页面数据
function _batchDelete(){
	if($("input[name='sub']:checked").length == 0){
		parent.layer.msg("请至少选择一条数据", {time: 2000});
	}else{
		$("input[name='sub']:checked").each(function(k,v){
			   $(v).parent().parent().remove();
			   sort();
		});
	}
}

//全选、全不选
$("#checkAll").click(function() {
    $("input[name='sub']").prop("checked", this.checked);
});
$("input[name='sub']").click(function() {
    var subs = $("input[name='sub']");
    $("#checkAll").prop("checked" , subs.length == subs.filter(":checked").length ? true :false);
});

//扫码录入
function AddProduct(self) {
    var barcode = $.trim($(self).val());
    var flag = true;
    if(barcode!=null){
        if(barcode.length>9){               
            $("tbody tr").each(function(k,v){
                if(barcode == $(v).find("td").eq(2).html()){
                    parent.layer.msg("该条码已经录入", {time: 2000});
                    $(self).val("");
                    flag = false;
                };
            })
            if(flag){
                $.post("/private/finishedout/getFinishedByNum",{"num":barcode},function(list){
                    // return;
                    if(list.length > 0){
                    	$(list).each(function () {
                    		var record = this;
                    		$("tbody").append(
                                    "<tr>"
                                    +"<td><input type='checkbox' name='sub' value=''><input hidden=''></td>"
                                    +"<td></td>"
                                    +"<td>"+record.finished_number+"</td>"
                                    +"<td>"+record.trade_name+"</td>"
                                    +"<td>"+record.specifications+"</td>"
                                    +"<td>"+record.measurement_unit+"</td>"
                                    +'<td>' + record.remark + '</td>' +
                                    '<td>' + record.warehouse_name + '</td>' +
                                    '<td>'+
                                        '<div class="form-group form-group-sm">'+
                                            '<input type="text" class="form-control" name="num" value="' + record.left_quantity + '">'+
                                        '</div>'+
                                    '</td>'+
                                +"</tr>"        
                            )
                    	});
                        
                        sort();
                        $(self).val("");
                    }else{
                        parent.layer.msg("请录入正确的半成品条码", {time: 2000});
                        $(self).val("");
                    }

                })
            }
        }
    }
    $(self).val("");
}

</script>
</body>

</html>
